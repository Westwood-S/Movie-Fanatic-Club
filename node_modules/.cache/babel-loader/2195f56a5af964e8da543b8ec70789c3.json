{"ast":null,"code":"var aws4 = exports,\n    url = require('url'),\n    querystring = require('querystring'),\n    crypto = require('crypto'),\n    lru = require('./lru'),\n    credentialsCache = lru(1000); // http://docs.amazonwebservices.com/general/latest/gr/signature-version-4.html\n\n\nfunction hmac(key, string, encoding) {\n  return crypto.createHmac('sha256', key).update(string, 'utf8').digest(encoding);\n}\n\nfunction hash(string, encoding) {\n  return crypto.createHash('sha256').update(string, 'utf8').digest(encoding);\n} // This function assumes the string has already been percent encoded\n\n\nfunction encodeRfc3986(urlEncodedString) {\n  return urlEncodedString.replace(/[!'()*]/g, function (c) {\n    return '%' + c.charCodeAt(0).toString(16).toUpperCase();\n  });\n}\n\nfunction encodeRfc3986Full(str) {\n  return encodeRfc3986(encodeURIComponent(str));\n} // request: { path | body, [host], [method], [headers], [service], [region] }\n// credentials: { accessKeyId, secretAccessKey, [sessionToken] }\n\n\nfunction RequestSigner(request, credentials) {\n  if (typeof request === 'string') request = url.parse(request);\n  var headers = request.headers = request.headers || {},\n      hostParts = this.matchHost(request.hostname || request.host || headers.Host || headers.host);\n  this.request = request;\n  this.credentials = credentials || this.defaultCredentials();\n  this.service = request.service || hostParts[0] || '';\n  this.region = request.region || hostParts[1] || 'us-east-1'; // SES uses a different domain from the service name\n\n  if (this.service === 'email') this.service = 'ses';\n  if (!request.method && request.body) request.method = 'POST';\n\n  if (!headers.Host && !headers.host) {\n    headers.Host = request.hostname || request.host || this.createHost(); // If a port is specified explicitly, use it as is\n\n    if (request.port) headers.Host += ':' + request.port;\n  }\n\n  if (!request.hostname && !request.host) request.hostname = headers.Host || headers.host;\n  this.isCodeCommitGit = this.service === 'codecommit' && request.method === 'GIT';\n}\n\nRequestSigner.prototype.matchHost = function (host) {\n  var match = (host || '').match(/([^\\.]+)\\.(?:([^\\.]*)\\.)?amazonaws\\.com(\\.cn)?$/);\n  var hostParts = (match || []).slice(1, 3); // ES's hostParts are sometimes the other way round, if the value that is expected\n  // to be region equals ‘es’ switch them back\n  // e.g. search-cluster-name-aaaa00aaaa0aaa0aaaaaaa0aaa.us-east-1.es.amazonaws.com\n\n  if (hostParts[1] === 'es') hostParts = hostParts.reverse();\n  return hostParts;\n}; // http://docs.aws.amazon.com/general/latest/gr/rande.html\n\n\nRequestSigner.prototype.isSingleRegion = function () {\n  // Special case for S3 and SimpleDB in us-east-1\n  if (['s3', 'sdb'].indexOf(this.service) >= 0 && this.region === 'us-east-1') return true;\n  return ['cloudfront', 'ls', 'route53', 'iam', 'importexport', 'sts'].indexOf(this.service) >= 0;\n};\n\nRequestSigner.prototype.createHost = function () {\n  var region = this.isSingleRegion() ? '' : (this.service === 's3' && this.region !== 'us-east-1' ? '-' : '.') + this.region,\n      service = this.service === 'ses' ? 'email' : this.service;\n  return service + region + '.amazonaws.com';\n};\n\nRequestSigner.prototype.prepareRequest = function () {\n  this.parsePath();\n  var request = this.request,\n      headers = request.headers,\n      query;\n\n  if (request.signQuery) {\n    this.parsedPath.query = query = this.parsedPath.query || {};\n    if (this.credentials.sessionToken) query['X-Amz-Security-Token'] = this.credentials.sessionToken;\n    if (this.service === 's3' && !query['X-Amz-Expires']) query['X-Amz-Expires'] = 86400;\n    if (query['X-Amz-Date']) this.datetime = query['X-Amz-Date'];else query['X-Amz-Date'] = this.getDateTime();\n    query['X-Amz-Algorithm'] = 'AWS4-HMAC-SHA256';\n    query['X-Amz-Credential'] = this.credentials.accessKeyId + '/' + this.credentialString();\n    query['X-Amz-SignedHeaders'] = this.signedHeaders();\n  } else {\n    if (!request.doNotModifyHeaders && !this.isCodeCommitGit) {\n      if (request.body && !headers['Content-Type'] && !headers['content-type']) headers['Content-Type'] = 'application/x-www-form-urlencoded; charset=utf-8';\n      if (request.body && !headers['Content-Length'] && !headers['content-length']) headers['Content-Length'] = Buffer.byteLength(request.body);\n      if (this.credentials.sessionToken && !headers['X-Amz-Security-Token'] && !headers['x-amz-security-token']) headers['X-Amz-Security-Token'] = this.credentials.sessionToken;\n      if (this.service === 's3' && !headers['X-Amz-Content-Sha256'] && !headers['x-amz-content-sha256']) headers['X-Amz-Content-Sha256'] = hash(this.request.body || '', 'hex');\n      if (headers['X-Amz-Date'] || headers['x-amz-date']) this.datetime = headers['X-Amz-Date'] || headers['x-amz-date'];else headers['X-Amz-Date'] = this.getDateTime();\n    }\n\n    delete headers.Authorization;\n    delete headers.authorization;\n  }\n};\n\nRequestSigner.prototype.sign = function () {\n  if (!this.parsedPath) this.prepareRequest();\n\n  if (this.request.signQuery) {\n    this.parsedPath.query['X-Amz-Signature'] = this.signature();\n  } else {\n    this.request.headers.Authorization = this.authHeader();\n  }\n\n  this.request.path = this.formatPath();\n  return this.request;\n};\n\nRequestSigner.prototype.getDateTime = function () {\n  if (!this.datetime) {\n    var headers = this.request.headers,\n        date = new Date(headers.Date || headers.date || new Date());\n    this.datetime = date.toISOString().replace(/[:\\-]|\\.\\d{3}/g, ''); // Remove the trailing 'Z' on the timestamp string for CodeCommit git access\n\n    if (this.isCodeCommitGit) this.datetime = this.datetime.slice(0, -1);\n  }\n\n  return this.datetime;\n};\n\nRequestSigner.prototype.getDate = function () {\n  return this.getDateTime().substr(0, 8);\n};\n\nRequestSigner.prototype.authHeader = function () {\n  return ['AWS4-HMAC-SHA256 Credential=' + this.credentials.accessKeyId + '/' + this.credentialString(), 'SignedHeaders=' + this.signedHeaders(), 'Signature=' + this.signature()].join(', ');\n};\n\nRequestSigner.prototype.signature = function () {\n  var date = this.getDate(),\n      cacheKey = [this.credentials.secretAccessKey, date, this.region, this.service].join(),\n      kDate,\n      kRegion,\n      kService,\n      kCredentials = credentialsCache.get(cacheKey);\n\n  if (!kCredentials) {\n    kDate = hmac('AWS4' + this.credentials.secretAccessKey, date);\n    kRegion = hmac(kDate, this.region);\n    kService = hmac(kRegion, this.service);\n    kCredentials = hmac(kService, 'aws4_request');\n    credentialsCache.set(cacheKey, kCredentials);\n  }\n\n  return hmac(kCredentials, this.stringToSign(), 'hex');\n};\n\nRequestSigner.prototype.stringToSign = function () {\n  return ['AWS4-HMAC-SHA256', this.getDateTime(), this.credentialString(), hash(this.canonicalString(), 'hex')].join('\\n');\n};\n\nRequestSigner.prototype.canonicalString = function () {\n  if (!this.parsedPath) this.prepareRequest();\n  var pathStr = this.parsedPath.path,\n      query = this.parsedPath.query,\n      headers = this.request.headers,\n      queryStr = '',\n      normalizePath = this.service !== 's3',\n      decodePath = this.service === 's3' || this.request.doNotEncodePath,\n      decodeSlashesInPath = this.service === 's3',\n      firstValOnly = this.service === 's3',\n      bodyHash;\n\n  if (this.service === 's3' && this.request.signQuery) {\n    bodyHash = 'UNSIGNED-PAYLOAD';\n  } else if (this.isCodeCommitGit) {\n    bodyHash = '';\n  } else {\n    bodyHash = headers['X-Amz-Content-Sha256'] || headers['x-amz-content-sha256'] || hash(this.request.body || '', 'hex');\n  }\n\n  if (query) {\n    var reducedQuery = Object.keys(query).reduce(function (obj, key) {\n      if (!key) return obj;\n      obj[encodeRfc3986Full(key)] = !Array.isArray(query[key]) ? query[key] : firstValOnly ? query[key][0] : query[key];\n      return obj;\n    }, {});\n    var encodedQueryPieces = [];\n    Object.keys(reducedQuery).sort().forEach(function (key) {\n      if (!Array.isArray(reducedQuery[key])) {\n        encodedQueryPieces.push(key + '=' + encodeRfc3986Full(reducedQuery[key]));\n      } else {\n        reducedQuery[key].map(encodeRfc3986Full).sort().forEach(function (val) {\n          encodedQueryPieces.push(key + '=' + val);\n        });\n      }\n    });\n    queryStr = encodedQueryPieces.join('&');\n  }\n\n  if (pathStr !== '/') {\n    if (normalizePath) pathStr = pathStr.replace(/\\/{2,}/g, '/');\n    pathStr = pathStr.split('/').reduce(function (path, piece) {\n      if (normalizePath && piece === '..') {\n        path.pop();\n      } else if (!normalizePath || piece !== '.') {\n        if (decodePath) piece = decodeURIComponent(piece).replace(/\\+/g, ' ');\n        path.push(encodeRfc3986Full(piece));\n      }\n\n      return path;\n    }, []).join('/');\n    if (pathStr[0] !== '/') pathStr = '/' + pathStr;\n    if (decodeSlashesInPath) pathStr = pathStr.replace(/%2F/g, '/');\n  }\n\n  return [this.request.method || 'GET', pathStr, queryStr, this.canonicalHeaders() + '\\n', this.signedHeaders(), bodyHash].join('\\n');\n};\n\nRequestSigner.prototype.canonicalHeaders = function () {\n  var headers = this.request.headers;\n\n  function trimAll(header) {\n    return header.toString().trim().replace(/\\s+/g, ' ');\n  }\n\n  return Object.keys(headers).sort(function (a, b) {\n    return a.toLowerCase() < b.toLowerCase() ? -1 : 1;\n  }).map(function (key) {\n    return key.toLowerCase() + ':' + trimAll(headers[key]);\n  }).join('\\n');\n};\n\nRequestSigner.prototype.signedHeaders = function () {\n  return Object.keys(this.request.headers).map(function (key) {\n    return key.toLowerCase();\n  }).sort().join(';');\n};\n\nRequestSigner.prototype.credentialString = function () {\n  return [this.getDate(), this.region, this.service, 'aws4_request'].join('/');\n};\n\nRequestSigner.prototype.defaultCredentials = function () {\n  var env = process.env;\n  return {\n    accessKeyId: env.AWS_ACCESS_KEY_ID || env.AWS_ACCESS_KEY,\n    secretAccessKey: env.AWS_SECRET_ACCESS_KEY || env.AWS_SECRET_KEY,\n    sessionToken: env.AWS_SESSION_TOKEN\n  };\n};\n\nRequestSigner.prototype.parsePath = function () {\n  var path = this.request.path || '/'; // S3 doesn't always encode characters > 127 correctly and\n  // all services don't encode characters > 255 correctly\n  // So if there are non-reserved chars (and it's not already all % encoded), just encode them all\n\n  if (/[^0-9A-Za-z;,/?:@&=+$\\-_.!~*'()#%]/.test(path)) {\n    path = encodeURI(decodeURI(path));\n  }\n\n  var queryIx = path.indexOf('?'),\n      query = null;\n\n  if (queryIx >= 0) {\n    query = querystring.parse(path.slice(queryIx + 1));\n    path = path.slice(0, queryIx);\n  }\n\n  this.parsedPath = {\n    path: path,\n    query: query\n  };\n};\n\nRequestSigner.prototype.formatPath = function () {\n  var path = this.parsedPath.path,\n      query = this.parsedPath.query;\n  if (!query) return path; // Services don't support empty query string keys\n\n  if (query[''] != null) delete query[''];\n  return path + '?' + encodeRfc3986(querystring.stringify(query));\n};\n\naws4.RequestSigner = RequestSigner;\n\naws4.sign = function (request, credentials) {\n  return new RequestSigner(request, credentials).sign();\n};","map":{"version":3,"sources":["C:/Users/molli/Desktop/full-stack/movie-fanatic-club/node_modules/aws4/aws4.js"],"names":["aws4","exports","url","require","querystring","crypto","lru","credentialsCache","hmac","key","string","encoding","createHmac","update","digest","hash","createHash","encodeRfc3986","urlEncodedString","replace","c","charCodeAt","toString","toUpperCase","encodeRfc3986Full","str","encodeURIComponent","RequestSigner","request","credentials","parse","headers","hostParts","matchHost","hostname","host","Host","defaultCredentials","service","region","method","body","createHost","port","isCodeCommitGit","prototype","match","slice","reverse","isSingleRegion","indexOf","prepareRequest","parsePath","query","signQuery","parsedPath","sessionToken","datetime","getDateTime","accessKeyId","credentialString","signedHeaders","doNotModifyHeaders","Buffer","byteLength","Authorization","authorization","sign","signature","authHeader","path","formatPath","date","Date","toISOString","getDate","substr","join","cacheKey","secretAccessKey","kDate","kRegion","kService","kCredentials","get","set","stringToSign","canonicalString","pathStr","queryStr","normalizePath","decodePath","doNotEncodePath","decodeSlashesInPath","firstValOnly","bodyHash","reducedQuery","Object","keys","reduce","obj","Array","isArray","encodedQueryPieces","sort","forEach","push","map","val","split","piece","pop","decodeURIComponent","canonicalHeaders","trimAll","header","trim","a","b","toLowerCase","env","process","AWS_ACCESS_KEY_ID","AWS_ACCESS_KEY","AWS_SECRET_ACCESS_KEY","AWS_SECRET_KEY","AWS_SESSION_TOKEN","test","encodeURI","decodeURI","queryIx","stringify"],"mappings":"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","sourcesContent":["var aws4 = exports,\r\n    url = require('url'),\r\n    querystring = require('querystring'),\r\n    crypto = require('crypto'),\r\n    lru = require('./lru'),\r\n    credentialsCache = lru(1000)\r\n\r\n// http://docs.amazonwebservices.com/general/latest/gr/signature-version-4.html\r\n\r\nfunction hmac(key, string, encoding) {\r\n  return crypto.createHmac('sha256', key).update(string, 'utf8').digest(encoding)\r\n}\r\n\r\nfunction hash(string, encoding) {\r\n  return crypto.createHash('sha256').update(string, 'utf8').digest(encoding)\r\n}\r\n\r\n// This function assumes the string has already been percent encoded\r\nfunction encodeRfc3986(urlEncodedString) {\r\n  return urlEncodedString.replace(/[!'()*]/g, function(c) {\r\n    return '%' + c.charCodeAt(0).toString(16).toUpperCase()\r\n  })\r\n}\r\n\r\nfunction encodeRfc3986Full(str) {\r\n  return encodeRfc3986(encodeURIComponent(str))\r\n}\r\n\r\n// request: { path | body, [host], [method], [headers], [service], [region] }\r\n// credentials: { accessKeyId, secretAccessKey, [sessionToken] }\r\nfunction RequestSigner(request, credentials) {\r\n\r\n  if (typeof request === 'string') request = url.parse(request)\r\n\r\n  var headers = request.headers = (request.headers || {}),\r\n      hostParts = this.matchHost(request.hostname || request.host || headers.Host || headers.host)\r\n\r\n  this.request = request\r\n  this.credentials = credentials || this.defaultCredentials()\r\n\r\n  this.service = request.service || hostParts[0] || ''\r\n  this.region = request.region || hostParts[1] || 'us-east-1'\r\n\r\n  // SES uses a different domain from the service name\r\n  if (this.service === 'email') this.service = 'ses'\r\n\r\n  if (!request.method && request.body)\r\n    request.method = 'POST'\r\n\r\n  if (!headers.Host && !headers.host) {\r\n    headers.Host = request.hostname || request.host || this.createHost()\r\n\r\n    // If a port is specified explicitly, use it as is\r\n    if (request.port)\r\n      headers.Host += ':' + request.port\r\n  }\r\n  if (!request.hostname && !request.host)\r\n    request.hostname = headers.Host || headers.host\r\n\r\n  this.isCodeCommitGit = this.service === 'codecommit' && request.method === 'GIT'\r\n}\r\n\r\nRequestSigner.prototype.matchHost = function(host) {\r\n  var match = (host || '').match(/([^\\.]+)\\.(?:([^\\.]*)\\.)?amazonaws\\.com(\\.cn)?$/)\r\n  var hostParts = (match || []).slice(1, 3)\r\n\r\n  // ES's hostParts are sometimes the other way round, if the value that is expected\r\n  // to be region equals ‘es’ switch them back\r\n  // e.g. search-cluster-name-aaaa00aaaa0aaa0aaaaaaa0aaa.us-east-1.es.amazonaws.com\r\n  if (hostParts[1] === 'es')\r\n    hostParts = hostParts.reverse()\r\n\r\n  return hostParts\r\n}\r\n\r\n// http://docs.aws.amazon.com/general/latest/gr/rande.html\r\nRequestSigner.prototype.isSingleRegion = function() {\r\n  // Special case for S3 and SimpleDB in us-east-1\r\n  if (['s3', 'sdb'].indexOf(this.service) >= 0 && this.region === 'us-east-1') return true\r\n\r\n  return ['cloudfront', 'ls', 'route53', 'iam', 'importexport', 'sts']\r\n    .indexOf(this.service) >= 0\r\n}\r\n\r\nRequestSigner.prototype.createHost = function() {\r\n  var region = this.isSingleRegion() ? '' :\r\n        (this.service === 's3' && this.region !== 'us-east-1' ? '-' : '.') + this.region,\r\n      service = this.service === 'ses' ? 'email' : this.service\r\n  return service + region + '.amazonaws.com'\r\n}\r\n\r\nRequestSigner.prototype.prepareRequest = function() {\r\n  this.parsePath()\r\n\r\n  var request = this.request, headers = request.headers, query\r\n\r\n  if (request.signQuery) {\r\n\r\n    this.parsedPath.query = query = this.parsedPath.query || {}\r\n\r\n    if (this.credentials.sessionToken)\r\n      query['X-Amz-Security-Token'] = this.credentials.sessionToken\r\n\r\n    if (this.service === 's3' && !query['X-Amz-Expires'])\r\n      query['X-Amz-Expires'] = 86400\r\n\r\n    if (query['X-Amz-Date'])\r\n      this.datetime = query['X-Amz-Date']\r\n    else\r\n      query['X-Amz-Date'] = this.getDateTime()\r\n\r\n    query['X-Amz-Algorithm'] = 'AWS4-HMAC-SHA256'\r\n    query['X-Amz-Credential'] = this.credentials.accessKeyId + '/' + this.credentialString()\r\n    query['X-Amz-SignedHeaders'] = this.signedHeaders()\r\n\r\n  } else {\r\n\r\n    if (!request.doNotModifyHeaders && !this.isCodeCommitGit) {\r\n      if (request.body && !headers['Content-Type'] && !headers['content-type'])\r\n        headers['Content-Type'] = 'application/x-www-form-urlencoded; charset=utf-8'\r\n\r\n      if (request.body && !headers['Content-Length'] && !headers['content-length'])\r\n        headers['Content-Length'] = Buffer.byteLength(request.body)\r\n\r\n      if (this.credentials.sessionToken && !headers['X-Amz-Security-Token'] && !headers['x-amz-security-token'])\r\n        headers['X-Amz-Security-Token'] = this.credentials.sessionToken\r\n\r\n      if (this.service === 's3' && !headers['X-Amz-Content-Sha256'] && !headers['x-amz-content-sha256'])\r\n        headers['X-Amz-Content-Sha256'] = hash(this.request.body || '', 'hex')\r\n\r\n      if (headers['X-Amz-Date'] || headers['x-amz-date'])\r\n        this.datetime = headers['X-Amz-Date'] || headers['x-amz-date']\r\n      else\r\n        headers['X-Amz-Date'] = this.getDateTime()\r\n    }\r\n\r\n    delete headers.Authorization\r\n    delete headers.authorization\r\n  }\r\n}\r\n\r\nRequestSigner.prototype.sign = function() {\r\n  if (!this.parsedPath) this.prepareRequest()\r\n\r\n  if (this.request.signQuery) {\r\n    this.parsedPath.query['X-Amz-Signature'] = this.signature()\r\n  } else {\r\n    this.request.headers.Authorization = this.authHeader()\r\n  }\r\n\r\n  this.request.path = this.formatPath()\r\n\r\n  return this.request\r\n}\r\n\r\nRequestSigner.prototype.getDateTime = function() {\r\n  if (!this.datetime) {\r\n    var headers = this.request.headers,\r\n      date = new Date(headers.Date || headers.date || new Date)\r\n\r\n    this.datetime = date.toISOString().replace(/[:\\-]|\\.\\d{3}/g, '')\r\n\r\n    // Remove the trailing 'Z' on the timestamp string for CodeCommit git access\r\n    if (this.isCodeCommitGit) this.datetime = this.datetime.slice(0, -1)\r\n  }\r\n  return this.datetime\r\n}\r\n\r\nRequestSigner.prototype.getDate = function() {\r\n  return this.getDateTime().substr(0, 8)\r\n}\r\n\r\nRequestSigner.prototype.authHeader = function() {\r\n  return [\r\n    'AWS4-HMAC-SHA256 Credential=' + this.credentials.accessKeyId + '/' + this.credentialString(),\r\n    'SignedHeaders=' + this.signedHeaders(),\r\n    'Signature=' + this.signature(),\r\n  ].join(', ')\r\n}\r\n\r\nRequestSigner.prototype.signature = function() {\r\n  var date = this.getDate(),\r\n      cacheKey = [this.credentials.secretAccessKey, date, this.region, this.service].join(),\r\n      kDate, kRegion, kService, kCredentials = credentialsCache.get(cacheKey)\r\n  if (!kCredentials) {\r\n    kDate = hmac('AWS4' + this.credentials.secretAccessKey, date)\r\n    kRegion = hmac(kDate, this.region)\r\n    kService = hmac(kRegion, this.service)\r\n    kCredentials = hmac(kService, 'aws4_request')\r\n    credentialsCache.set(cacheKey, kCredentials)\r\n  }\r\n  return hmac(kCredentials, this.stringToSign(), 'hex')\r\n}\r\n\r\nRequestSigner.prototype.stringToSign = function() {\r\n  return [\r\n    'AWS4-HMAC-SHA256',\r\n    this.getDateTime(),\r\n    this.credentialString(),\r\n    hash(this.canonicalString(), 'hex'),\r\n  ].join('\\n')\r\n}\r\n\r\nRequestSigner.prototype.canonicalString = function() {\r\n  if (!this.parsedPath) this.prepareRequest()\r\n\r\n  var pathStr = this.parsedPath.path,\r\n      query = this.parsedPath.query,\r\n      headers = this.request.headers,\r\n      queryStr = '',\r\n      normalizePath = this.service !== 's3',\r\n      decodePath = this.service === 's3' || this.request.doNotEncodePath,\r\n      decodeSlashesInPath = this.service === 's3',\r\n      firstValOnly = this.service === 's3',\r\n      bodyHash\r\n\r\n  if (this.service === 's3' && this.request.signQuery) {\r\n    bodyHash = 'UNSIGNED-PAYLOAD'\r\n  } else if (this.isCodeCommitGit) {\r\n    bodyHash = ''\r\n  } else {\r\n    bodyHash = headers['X-Amz-Content-Sha256'] || headers['x-amz-content-sha256'] ||\r\n      hash(this.request.body || '', 'hex')\r\n  }\r\n\r\n  if (query) {\r\n    var reducedQuery = Object.keys(query).reduce(function(obj, key) {\r\n      if (!key) return obj\r\n      obj[encodeRfc3986Full(key)] = !Array.isArray(query[key]) ? query[key] :\r\n        (firstValOnly ? query[key][0] : query[key])\r\n      return obj\r\n    }, {})\r\n    var encodedQueryPieces = []\r\n    Object.keys(reducedQuery).sort().forEach(function(key) {\r\n      if (!Array.isArray(reducedQuery[key])) {\r\n        encodedQueryPieces.push(key + '=' + encodeRfc3986Full(reducedQuery[key]))\r\n      } else {\r\n        reducedQuery[key].map(encodeRfc3986Full).sort()\r\n          .forEach(function(val) { encodedQueryPieces.push(key + '=' + val) })\r\n      }\r\n    })\r\n    queryStr = encodedQueryPieces.join('&')\r\n  }\r\n  if (pathStr !== '/') {\r\n    if (normalizePath) pathStr = pathStr.replace(/\\/{2,}/g, '/')\r\n    pathStr = pathStr.split('/').reduce(function(path, piece) {\r\n      if (normalizePath && piece === '..') {\r\n        path.pop()\r\n      } else if (!normalizePath || piece !== '.') {\r\n        if (decodePath) piece = decodeURIComponent(piece).replace(/\\+/g, ' ')\r\n        path.push(encodeRfc3986Full(piece))\r\n      }\r\n      return path\r\n    }, []).join('/')\r\n    if (pathStr[0] !== '/') pathStr = '/' + pathStr\r\n    if (decodeSlashesInPath) pathStr = pathStr.replace(/%2F/g, '/')\r\n  }\r\n\r\n  return [\r\n    this.request.method || 'GET',\r\n    pathStr,\r\n    queryStr,\r\n    this.canonicalHeaders() + '\\n',\r\n    this.signedHeaders(),\r\n    bodyHash,\r\n  ].join('\\n')\r\n}\r\n\r\nRequestSigner.prototype.canonicalHeaders = function() {\r\n  var headers = this.request.headers\r\n  function trimAll(header) {\r\n    return header.toString().trim().replace(/\\s+/g, ' ')\r\n  }\r\n  return Object.keys(headers)\r\n    .sort(function(a, b) { return a.toLowerCase() < b.toLowerCase() ? -1 : 1 })\r\n    .map(function(key) { return key.toLowerCase() + ':' + trimAll(headers[key]) })\r\n    .join('\\n')\r\n}\r\n\r\nRequestSigner.prototype.signedHeaders = function() {\r\n  return Object.keys(this.request.headers)\r\n    .map(function(key) { return key.toLowerCase() })\r\n    .sort()\r\n    .join(';')\r\n}\r\n\r\nRequestSigner.prototype.credentialString = function() {\r\n  return [\r\n    this.getDate(),\r\n    this.region,\r\n    this.service,\r\n    'aws4_request',\r\n  ].join('/')\r\n}\r\n\r\nRequestSigner.prototype.defaultCredentials = function() {\r\n  var env = process.env\r\n  return {\r\n    accessKeyId: env.AWS_ACCESS_KEY_ID || env.AWS_ACCESS_KEY,\r\n    secretAccessKey: env.AWS_SECRET_ACCESS_KEY || env.AWS_SECRET_KEY,\r\n    sessionToken: env.AWS_SESSION_TOKEN,\r\n  }\r\n}\r\n\r\nRequestSigner.prototype.parsePath = function() {\r\n  var path = this.request.path || '/'\r\n\r\n  // S3 doesn't always encode characters > 127 correctly and\r\n  // all services don't encode characters > 255 correctly\r\n  // So if there are non-reserved chars (and it's not already all % encoded), just encode them all\r\n  if (/[^0-9A-Za-z;,/?:@&=+$\\-_.!~*'()#%]/.test(path)) {\r\n    path = encodeURI(decodeURI(path))\r\n  }\r\n\r\n  var queryIx = path.indexOf('?'),\r\n      query = null\r\n\r\n  if (queryIx >= 0) {\r\n    query = querystring.parse(path.slice(queryIx + 1))\r\n    path = path.slice(0, queryIx)\r\n  }\r\n\r\n  this.parsedPath = {\r\n    path: path,\r\n    query: query,\r\n  }\r\n}\r\n\r\nRequestSigner.prototype.formatPath = function() {\r\n  var path = this.parsedPath.path,\r\n      query = this.parsedPath.query\r\n\r\n  if (!query) return path\r\n\r\n  // Services don't support empty query string keys\r\n  if (query[''] != null) delete query['']\r\n\r\n  return path + '?' + encodeRfc3986(querystring.stringify(query))\r\n}\r\n\r\naws4.RequestSigner = RequestSigner\r\n\r\naws4.sign = function(request, credentials) {\r\n  return new RequestSigner(request, credentials).sign()\r\n}\r\n"]},"metadata":{},"sourceType":"script"}